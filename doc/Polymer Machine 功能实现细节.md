# Polymer Machine 功能实现细节

#### 组件定义

- 组件是一个对象，它表示机器的一个输入输出类型
- 组件容纳一个具体的`Handler`
- 组件提供了具体内容的序列化/反序列化方案（如果有）
- 组件提供了网络同步方案（如果有）
- 组件提供了GUI显示方案（如果有）
- 组件提供了方块需要实现的API
- 在脚本中，组件可以有以下操作
  - `define`：新建一个组件并将组件的序列化等方法与方块绑定
  - `apply`：在要创建的方块中应用该组件的API（Capability或接口）
  - `adapt`：将一种类型的组件适配成另一种类型的组件
  - `export`：（多方快/部件）将一个部件中的组件暴露给其他部件
  - `import`：（多方快/核心）导入一个部件中export的组件
  - `wrapper`：（多方快/核心）将一个非Polymer方块包装为组件
  - `combine`：（多方快/核心）合并同类型的组件
  - `collect`：（多方快/核心）import/wrapper + combine
  - `bridge`：（多方快/核心）将其他部件的IO桥接到核心的组件
- 通常情况下，组件可以和`Capability`等互相转换
- 合成表的一系列参数主要为组件
- 在脚本中检查组件各个方法的调用情况

###### TODO:

- [x] 组件类
- [ ] 实现：物品
- [ ] 实现：流体
- [ ] 实现：能量
- [ ] 懒加载组件

#### 组件容器

- 组件容器是一个对象，它根据脚本的定义构造出来
- 除了`define`的组件全部懒加载
- 组件容器提供以下方法
  - `get`方法：获取组件对象
  - `apply`方法：由方块构造器调用
  - `invalidate`方法：删缓存/（多方快）去除其他部件的bridge
  - `provide`方法：（多方快）组装时候调用，提供其他组件容器的位置
  - `broadcast`方法：（多方快）组装时候调用，将bridge的组件应用到其他部件

#### 方块构造器



## 机器流程

#### 设计可以实现的机器方案

如下为需求列表，用于确认下述定义是否能够实现这一系列需求

- [ ] 基本输入输出
- [ ] 输入延迟消耗
- [ ] 熔炉燃料处理
- [ ] 根据合成表决定机器处理时间
- [ ] 纯输出机器（太阳能发电机）
- [ ] 纯消耗机器/标记机器（稳定器）
- [ ] 分布式输入（注入合成装置）
- [ ] 被动触发（符文祭坛）
- [ ] 掉落物输入（精灵传送门）
- [ ] 主动充能（注魔祭坛）
- [ ] 被动充能（符文祭坛）
- [ ] 存储系（大型魔力池子）
- [ ] 存储系（巨型储罐）
- [ ] 聚变反应堆（机器预热）
- [ ] 输入输出代理（匠魂冶炼炉）
- [ ] 仿沉浸系机器
- [ ] 玩家buff（信标）

#### 机器流程定义

- 机器流程使用一系列流水线构造
- 一个机器流程只能有一个主流水线，其他的流水线只能通过`Trigger`指令触发（待定）
- 机器流程内所有处理使用响应式API监听并按需同步，监听者可以通过同样的响应式API监听变化
- 

#### 机器状态机

- 流水线的实际表现方式为状态机
- 在脚本中可以使用较为线性的方式定义，但最终都会处理成状态机

#### 指令系统

###### 指令分类

- 触发器指令
- 单步指令
- 瞬时指令
- 持续指令：指令执行周期可以是多个tick
  - `delay`：延迟一固定tick
  - `waitFor`：等待指定条件达成
  - `checkFor`：循环检查指定条件
- 作用域指令：生成一个作用域，影响作用域内的指令
  - `apply`： 对作用域的指令应用额外参数
  - `watch`：监听某个变化并且向作用域内的指令发送事件
  - `ensure`：当某个条件不符合的时候取消作用域内指令的执行

- 条件指令
- 

###### 指令细节

###### 指令系统

#### 状态更新响应



